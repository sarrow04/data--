# -*- coding: utf-8 -*-
"""feature_engineering_app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1BieOy5ivxrM6RQsSPRK9IPwk0URt6gPw
"""

import streamlit as st
import pandas as pd

# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(layout="wide")
st.title("ãƒ‡ãƒ¼ã‚¿çµåˆ & ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚° ãƒ„ãƒ¼ãƒ« ğŸ”§")

# --- Session Stateã®åˆæœŸåŒ– ---
if 'df1' not in st.session_state: st.session_state.df1 = None
if 'df2' not in st.session_state: st.session_state.df2 = None
if 'merged_df' not in st.session_state: st.session_state.merged_df = None

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ ---
with st.sidebar:
    st.header("1. ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")

    uploaded_file1 = st.file_uploader("å·¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆdf1ï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type=["csv"])
    if uploaded_file1:
        st.session_state.df1 = pd.read_csv(uploaded_file1)

    uploaded_file2 = st.file_uploader("å³ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆdf2ï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type=["csv"])
    if uploaded_file2:
        st.session_state.df2 = pd.read_csv(uploaded_file2)

# --- ãƒ¡ã‚¤ãƒ³ç”»é¢ ---
if st.session_state.df1 is not None and st.session_state.df2 is not None:
    df1 = st.session_state.df1
    df2 = st.session_state.df2

    st.header("2. ãƒ‡ãƒ¼ã‚¿ã®çµåˆ")

    # çµåˆå‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    col1, col2 = st.columns(2)
    with col1:
        st.write("å·¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆdf1ï¼‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼")
        st.dataframe(df1.head())
    with col2:
        st.write("å³ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆdf2ï¼‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼")
        st.dataframe(df2.head())

    merge_type = st.radio("çµåˆã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„", ("æ¨ªã«çµåˆ (Join)", "ç¸¦ã«çµåˆ (Concatenate)"))

    if merge_type == "æ¨ªã«çµåˆ (Join)":
        st.subheader("æ¨ªã«çµåˆ (Join) ã®è¨­å®š")
        col1, col2, col3 = st.columns(3)
        with col1:
            left_on = st.selectbox("å·¦ã®ãƒ‡ãƒ¼ã‚¿ã®å…±é€šåˆ— (ã‚­ãƒ¼)", df1.columns)
        with col2:
            right_on = st.selectbox("å³ã®ãƒ‡ãƒ¼ã‚¿ã®å…±é€šåˆ— (ã‚­ãƒ¼)", df2.columns)
        with col3:
            how = st.selectbox("çµåˆæ–¹æ³•", ["inner", "left", "right", "outer"])

        if st.button("çµåˆã‚’å®Ÿè¡Œ"):
            try:
                merged_df = pd.merge(df1, df2, left_on=left_on, right_on=right_on, how=how)
                st.session_state.merged_df = merged_df
                st.success("ãƒ‡ãƒ¼ã‚¿ã®çµåˆã«æˆåŠŸã—ã¾ã—ãŸï¼")
            except Exception as e:
                st.error(f"çµåˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

    else: # ç¸¦ã«çµåˆ
        st.subheader("ç¸¦ã«çµåˆ (Concatenate)")
        st.info("2ã¤ã®ãƒ‡ãƒ¼ã‚¿ã®åˆ—åã¨é †åºãŒåŒã˜å ´åˆã«æœ€ã‚‚åŠ¹æœçš„ã§ã™ã€‚")
        if st.button("çµåˆã‚’å®Ÿè¡Œ"):
            try:
                merged_df = pd.concat([df1, df2], ignore_index=True)
                st.session_state.merged_df = merged_df
                st.success("ãƒ‡ãƒ¼ã‚¿ã®çµåˆã«æˆåŠŸã—ã¾ã—ãŸï¼")
            except Exception as e:
                st.error(f"çµåˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# --- çµåˆå¾Œã®å‡¦ç† ---
if st.session_state.merged_df is not None:
    merged_df = st.session_state.merged_df

    st.header("3. çµåˆå¾Œãƒ‡ãƒ¼ã‚¿ã¨ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°")
    st.dataframe(merged_df.head())

    st.subheader("ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚° ãƒ„ãƒ¼ãƒ«")

    # --- æ•°å€¤ãƒ‡ãƒ¼ã‚¿åŒå£«ã®è¨ˆç®— ---
    with st.expander("æ•°å€¤ãƒ‡ãƒ¼ã‚¿åŒå£«ã§æ–°ã—ã„ç‰¹å¾´é‡ã‚’ä½œæˆ"):
        numeric_cols = merged_df.select_dtypes(include=np.number).columns.tolist()
        col1, col2, col3 = st.columns(3)
        with col1:
            num_col1 = st.selectbox("ä¸€ã¤ç›®ã®åˆ—", numeric_cols, key="nc1")
        with col2:
            operator = st.selectbox("è¨ˆç®—æ–¹æ³•", ["+", "-", "*", "/"])
        with col3:
            num_col2 = st.selectbox("äºŒã¤ç›®ã®åˆ—", numeric_cols, key="nc2")
        new_col_name_calc = st.text_input("æ–°ã—ã„åˆ—ã®åå‰", f"{num_col1}_{operator}_{num_col2}")
        if st.button("è¨ˆç®—ã—ã¦åˆ—ã‚’è¿½åŠ "):
            try:
                merged_df[new_col_name_calc] = eval(f"merged_df['{num_col1}'] {operator} merged_df['{num_col2}']")
                st.session_state.merged_df = merged_df
                st.success(f"æ–°ã—ã„åˆ—ã€Œ{new_col_name_calc}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚")
                st.rerun()
            except Exception as e:
                st.error(f"è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

    # --- æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ç‰¹å¾´é‡ä½œæˆ ---
    with st.expander("æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ–°ã—ã„ç‰¹å¾´é‡ã‚’ä½œæˆ"):
        # æ—¥ä»˜ã«å¤‰æ›ã§ããã†ãªåˆ—ã‚’è‡ªå‹•ã§æ¢ã™
        potential_date_cols = [col for col in merged_df.columns if merged_df[col].astype(str).str.match(r'\d{4}[/-]\d{1,2}[/-]\d{1,2}').any()]
        date_col = st.selectbox("æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹åˆ—", potential_date_cols)
        if date_col:
            features_to_extract = st.multiselect("æŠ½å‡ºã—ãŸã„è¦ç´ ", ["å¹´", "æœˆ", "æ—¥", "æ›œæ—¥"])
            if st.button("æ—¥ä»˜ã‹ã‚‰ç‰¹å¾´é‡ã‚’æŠ½å‡º"):
                try:
                    dt_series = pd.to_datetime(merged_df[date_col])
                    if "å¹´" in features_to_extract: merged_df[f'{date_col}_å¹´'] = dt_series.dt.year
                    if "æœˆ" in features_to_extract: merged_df[f'{date_col}_æœˆ'] = dt_series.dt.month
                    if "æ—¥" in features_to_extract: merged_df[f'{date_col}_æ—¥'] = dt_series.dt.day
                    if "æ›œæ—¥" in features_to_extract: merged_df[f'{date_col}_æ›œæ—¥'] = dt_series.dt.day_name()
                    st.session_state.merged_df = merged_df
                    st.success(f"æ—¥ä»˜ã‹ã‚‰æ–°ã—ã„ç‰¹å¾´é‡ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚")
                    st.rerun()
                except Exception as e:
                    st.error(f"æ—¥ä»˜ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

    # --- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
    st.header("4. å®Œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰")
    csv = merged_df.to_csv(index=False).encode('utf--8')
    st.download_button(label="CSVã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", data=csv, file_name='engineered_data.csv', mime='text/csv')

else:
    st.info("ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰2ã¤ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨é–‹å§‹ã§ãã¾ã™ã€‚")